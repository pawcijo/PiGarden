<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Dashboard</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Default light mode styles */
        body {
            background-color: #fff;
            color: #000;
            font-family: Arial, sans-serif;
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            width: 100%;
            margin: auto;
        }

        canvas {
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 10px;
        }

        .cpu-temperature {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        #cpuTemperature {
            font-weight: bold;
            color: #000; /* Default color */
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #f1f1f1;
        }

        body.dark-mode #cpuTemperature {
            color: #f1f1f1; /* Adjust text color in dark mode */
        }

        /* Toggle button styles */
        .toggle-theme {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        body.dark-mode .toggle-theme {
            background-color: #ff9800;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button class="toggle-theme">Switch to Dark Mode</button>

    <h1>Sensor Data Dashboard</h1>

    <!-- Real-Time Sensor Data -->
    <div id="realtime-data">
        <h2>Real-Time Sensor Data</h2>
        <p>Soil Moisture: <span id="realtime-soil-moisture">Loading...</span>%</p>
        <p>Temperature: <span id="realtime-temperature">Loading...</span>째C</p>
        <p>Humidity: <span id="realtime-humidity">Loading...</span>%</p>
        <p>Raspberry Pi CPU Temperature: <span id="realtime-cpu-temperature">Loading...</span>째C</p>
    </div>

    <!-- Historical Data Graphs -->
    <h2>Historical Sensor Data ({{ recent_date }})</h2>
    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
        <canvas id="humidityChart"></canvas>
        <canvas id="soilMoistureChart"></canvas>
        <canvas id="cpuTempChart"></canvas>
    </div>

    <script>
        // Apply the saved theme from localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }

        const toggleButton = document.querySelector('.toggle-theme');
        toggleButton.textContent = document.body.classList.contains('dark-mode') 
            ? 'Switch to Light Mode' 
            : 'Switch to Dark Mode';

        toggleButton.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            toggleButton.textContent = isDarkMode 
                ? 'Switch to Light Mode' 
                : 'Switch to Dark Mode';
        });

        // Initialize Socket.IO for real-time data
        const socket = io("http://83.238.174.175:5000");

        // Update real-time data
        socket.on('broadcast', (data) => {
            document.getElementById('realtime-soil-moisture').textContent = data.soil_moisture || 'N/A';
            document.getElementById('realtime-temperature').textContent = data.temperature || 'N/A';
            document.getElementById('realtime-humidity').textContent = data.humidity || 'N/A';
            document.getElementById('realtime-cpu-temperature').textContent = data.cpu_temperature || 'N/A';
        });

        // Historical Data for Graphs
        const timestamps = {{ timestamps | tojson }};
        const temperatures = {{ temperatures | tojson }};
        const humidities = {{ humidities | tojson }};
        const soilMoistures = {{ soil_moistures | tojson }};
        const cpuTemperatures = {{ cpu_temperatures | tojson }};

        // Create charts for each data set
        function createChart(ctx, label, data, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps.reverse(),
                    datasets: [{
                        label: label,
                        data: data.reverse(),
                        borderColor: color,
                        backgroundColor: `${color}33`, // Transparent fill
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        createChart(document.getElementById('temperatureChart').getContext('2d'), 'Temperature (째C)', temperatures, 'rgb(255, 99, 132)');
        createChart(document.getElementById('humidityChart').getContext('2d'), 'Humidity (%)', humidities, 'rgb(54, 162, 235)');
        createChart(document.getElementById('soilMoistureChart').getContext('2d'), 'Soil Moisture (%)', soilMoistures, 'rgb(75, 192, 192)');
        createChart(document.getElementById('cpuTempChart').getContext('2d'), 'CPU Temperature (째C)', cpuTemperatures, 'rgb(255, 159, 64)');
    </script>
</body>
</html>
